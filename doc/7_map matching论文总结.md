# 路网匹配论文总结
路网匹配将GPS轨迹点映射到实际的路网上。大多数现存的路网匹配算法使用各种权值函数从候选点中决定正确的位置。权值可以由很多信息来决定，比如GPS点到候选边的距离，当前的前进方向，道路的拓扑结构，物体的瞬时速度以及前后点之间的关联等。

权值算法主要分为两类:增量算法和全局算法。增量算法每次读入最新的轨迹数据，只根据这个新数据和之前的已知数据来确定新数据所对应的的匹配的位置。增量算法更多的应用于实时应用场景。但是当采样率比较低的时候，匹配准确率下降的非常显著，也难以应付城市路网的复杂环境。

全局算法则是将一整段轨迹数据进行整体分析，所以可以对轨迹中的每一个点，利用该点前后的数据信息判断该点的最佳匹配位置。离线路网匹配使用全局算法能够获得更加准确的匹配的结果。如果一条轨迹的数据量太大，也有将轨迹数据进行切分的方式来达到提高匹配效率的问题。

----

## 1. Hidden Markov Map Matching Through Noise and Sparseness[GIS 2009]
首选浅谈一下隐马尔科夫模型HMM（Hidden Markov）。隐马尔科夫模型HMM是一个描述一个含有未知参数的马尔可夫过程统计模型。隐式马尔科夫模型五要素: 2个状态集合和3个概率矩阵。

>隐含状态S：马尔可夫模型中实际所隐含的状态，通常无法通过直接观测得到。这些状态之间满足马尔可夫性质
> 
>可观测状态O：可以通过直接观测而得到的状态，在隐马尔科夫模型中与隐含状态相关联。
>
>状态转移概率矩阵A：描述隐马尔可夫模型中各个状态之间的转移概率
>
>观测状态概率矩阵B：表示在t 时刻隐含状态是Sj 条件下，其可观测状态为Ok 的概率。
>
>初始状态概率矩阵π：表示隐含状态在初始时刻t=1 的概率矩阵

为了将隐马尔科夫模型HMM应用到路网匹配中，这里将每一个轨迹点作为一个可观测状态，将轨迹点组成的序列作为观测序列。而轨迹点的候选道路投影作为HMM求解的对象--隐含状态。由这些候选点（路段）构成的序列就是隐藏序列。这里需要决定的就是其转移概率和观测概率如何确定。隐马尔科夫模型HMM是路网匹配工作中非常流行的全局算法。

如何根据每个轨迹中的GPS点确定其由之前状态达到当前状态的具有最大的概率的候选点？一般是参考维特比算法（Viterbi）。其算法的主要思路是：
1. 初始化第一个观测点的所有可能状态概率。
2. 从前往后遍历每一个状态，对于每一个状态，用以下方法计算当前观测点的所有可能状态的概率：a)遍历当前观测可能对应的所有状态；b)对每个状态，遍历所有上一状态，通过公式 P(当前状态) = P(上一状态) * P(上一状态转移到当前状态) * P(当前状态观测) 来计算当前状态的概率。
3. 当所有观测点都遍历完之后，查找概率值最大的那个状态，然后查找这个概率值对应的上一状态，就这样一路往回找，所找到的序列（倒序的）就是最大概率的隐藏序列。

观测代价指代当前状态出现的代价。对应到路网匹配问题中，如何确定每个GPS点的观测代价呢？在这里一般的做法是将GPS点与其候选路段对应，一般而言，GPS定位的精度（每个点相对于路段的距离）大致满足正态分布，因此利用正态分布中的概率模型，可当做其观测概率。更多情况下，其观测代价可以由以下几个代价因素的进行加权平均：GPS点到路段的距离；GPS点前进方向和路段的方向差；GPS 点的速度与道路限速值的差异（低于限速值代价为 0，超过限速值就累加插值）。当然还有其他可以列入考虑的因素，根据不同的情况或不同的算法设计，可以采取不同的策略。

那么转移概率如何确定呢？转移代价指从上一个点到这一个点的前进过程中，从上一个点对应的某个路段到这个点对应的某个路段的代价。最一般的情况下，可以比较前一个点到当前点的真实路径距离和其两点之间距离的差值（比值）。如果值越小说明匹配的越正确。当然可以在之上考虑其他的因素，通过加权平均的方式协调各个因素对最终匹配结果的影响大小。

利用Viterbi算法，其步骤流程如下：
1. 对所有点序列进行遍历；
2. 对当前遍历到的点，进行周边抓路，将抓到的路标记为候选路段；
3. 如果不是第一个点，则将上一个点的所有保留下来的候选路段进行一定距离的扩散，获得范围内每两条路段之间的最短路径，仅保留起点是上一个点的备选路段且终点这个点的备选路段的路径；
4. 计算代价，计算方法为：上一个点的候选路段代价 + 到这个点对应候选路段的转换代价 + 这个点的观测代价；
5. 搜索到最后一个点的时候，找到代价最小的候选路段，然后依次往前追溯，找到计算出这个最小代价时经过的所有节点（包括转换路径上的路段）。

**在这篇论文中，作者通过经验和一定的数学推导最后得到的观测概率矩阵是$\mu$ = 0 和 $\sigma$ = 4.07的正态分布。$\sigma$使用绝对中位差进行鲁棒估计。状态转移矩阵是用指数函数来拟合前后两个相邻GPS观测点的距离与两个候选点距离之差的绝对值。在初始时刻使用观测概率矩阵。**

**在这篇论文中提出，可以使用滑动窗口的模式来处理实时数据的路网匹配（批处理模式）**

---

## Map-matching for low-sampling-rate GPS trajectories[GIS 2009]
ST-Matching 算法是一种处理低频采样数据的路网匹配算法。该算法是一种全局算法，能综合几何信息（GPS点与道路的距离）、道路拓扑信息（最短路径）、道路属性信息（每条道路的限速），具有精度高，稳定性好等优点。

作者基于的观测事实是：（1）真实的路径一般都是直的（2）真实的路径会遵循道路的速度限制。本文路网匹配的主要步骤是：先根据路网索引，取得轨迹点附近的候选路段（点）（网格索引）。（2）根据轨迹的前后关系，对候选路段进行空间分析和时间分析构建一张图，图的节点是轨迹点的匹配候选点，图的边是相邻候选点之间的最短路径，图中的边和点都赋予一定的权重。（3）在得到的图中，找到一条评分最高的轨迹。

空间分析：观测概率N：GPS坐标点p和投影点c之间的距离，计算该点与投影点相匹配的概率。作者使用的是$\mu$ = 0 和 $\sigma$ = 20正态分布。然而只考虑观测概率就忽略了GPS点的时空语义。因此作者还定义了转移概率V，其意义是GPS前后点之间的距离和其投影点之间的最短距离的比例。最终通过两个之积得到概率公式。
![](/pic/ST_matching_observation_probability.png)
![](/pic/ST_matching_transmission_probability.png)
![](/pic/ST_matching_function_probability.png)

时间分析：计算候选点之间的可能的速度与路径允许的速度作比较，判断其是在高速路上还是普通的路径上。
![](/pic/temporal_analysis_function.png)

最终得到的概率权重，用类似Viterbi算法，在全局找到一条评分最高的路径（初始概率设置为每个点的观测概率）。当一条轨迹太长时，可以使用滑动窗口的方式，对部分候选图进行匹配。

---

## DeepMM Deep Learning Based Map Matching with Data Augmentation \[SIGSPATIALGIS 2019]

在这篇文章中，作者的主要思想是结合已有的深度学习方法，充分利用历史轨迹数据的运动规律信息，来对轨迹的数据进行路网匹配，并减弱轨迹中噪声的影响。本篇文章中，通过embedding技术来表示地点和路段是为了减少敏感噪音的影响，而使用注意力增强的seq2seq模型是为了学习历史的轨迹数据特征。

![](/pic/deepMM_framework.png)

这个框架的左半部分是对轨迹数据量进行拓展的方法，右半部分是深度学习模型。通过训练的模型来对新来的轨迹进行预测，最后通过路网匹配算法来得到匹配的路网轨迹。

模型中的输入数据是基于线段的轨迹。首先将整张地图分成100*100的正方形区域，将每个区域的ID转成一个one-hot向量。将输入的序列转成向量来进行相应的预测和训练。

---

## Effective map-matching on the most simplified road network[SIGSPATIAL 2012]



这篇文章提出了一种Passby的路网匹配算法。主要针对问题是：由于路网数据占用很大的空间，如何在简化了路网信息的情况下进行路网匹配。这篇文章将路网信息中的每条路简化为（id，start，end）的集合。Passby考虑了轨迹中的前后点的关联，对每个点依次进行了匹配。该方法可以进行并行化计算，每个线程负责一部分地图数据的匹配。

---
 
Fast Viterbi map matching with tunable weight functions. SIGSPATIAL[[GIS 2012]]:该方法的全局路网匹配算法使用了Viterbi动态规划方法，该方法综合了其他几种路网匹配算法的权重计算函数，并使用了一些优化方法。

 
Quick map matching using multi-core CPUs[SIGSPATIALGIS 2012]：本文使用了网格索引，并将路段和相交的网格相对应，最后设置一定的距离限制，来取得查询轨迹中某个查询点一定范围内的在候选网格中的候选轨迹段。最后对每条轨迹进行隐式马尔科夫路网匹配（HMM）。该方法还考虑了对主路和辅路的匹配问题，辅路上的车辆车速比主路上的慢，因此在转移概率上加上了速度限制。这个方法用于多线程的地方主要是在：（1）将查询轨迹进行分段进行查找候选轨迹段。（2）轨迹间并行匹配。

 
An efficient algorithm for mapping vehicle trajectories onto road networks[SIGSPATIALGIS 2012]： 这篇文章首先对路网数据构建网格索引，基于构建的索引，根据轨迹的前后点的联系和一定的规则筛选符合要求的轨迹段进行路网匹配。

